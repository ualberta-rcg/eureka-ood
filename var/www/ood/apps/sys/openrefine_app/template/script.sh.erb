#!/bin/bash
echo "[script.sh.erb] Starting OpenRefine Server"

# Change to user's home directory
cd "${HOME}"
echo "[script.sh.erb] Changed working directory to ${HOME}"

# Load required modules (CVMFS: openrefine/3.9.3 requires StdEnv/2023)
echo "[script.sh.erb] Loading StdEnv/2023 and openrefine/3.9.3..."
module purge
if ! module load StdEnv/2023 openrefine/3.9.3; then
  echo "[script.sh.erb] ERROR: Failed to load openrefine/3.9.3 (StdEnv/2023). Check: module spider openrefine"
  exit 1
fi

# Resolve the IP on the 10.254.254.x network
REFINE_INTERFACE_IP=$(ip -4 addr show bond0.1757 | grep -oP '(?<=inet\s)\d+(\.\d+){3}')
if [[ -z "${REFINE_INTERFACE_IP}" ]]; then
  echo "[script.sh.erb] ERROR: Could not resolve IP for bond0.1757"
  exit 1
fi
echo "[script.sh.erb] Binding to interface IP: ${REFINE_INTERFACE_IP}"

# Resolve OpenRefine executable from module (CVMFS)
OPENREFINE_CMD=$(command -v refine 2>/dev/null || true)
if [[ -z "${OPENREFINE_CMD}" || ! -x "${OPENREFINE_CMD}" ]]; then
  echo "[script.sh.erb] ERROR: 'refine' not found after loading openrefine/3.9.3. PATH=$PATH"
  exit 1
fi
echo "[script.sh.erb] Using OpenRefine from CVMFS: $OPENREFINE_CMD"

# Set up OpenRefine environment
export REFINE_PORT="${port}"
export REFINE_DATA_DIR="${OPENREFINE_WORKDIR}"
export REFINE_HEADLESS="true"

# Create OpenRefine configuration
OPENREFINE_CONFIG="${OPENREFINE_WORKDIR}/refine.ini"
cat > "${OPENREFINE_CONFIG}" << EOF
port=${port}
host=${REFINE_INTERFACE_IP}
data-dir=${OPENREFINE_WORKDIR}
headless=true
EOF
echo "[script.sh.erb] OpenRefine configuration written to ${OPENREFINE_CONFIG}"

# Launch OpenRefine Server
echo "[script.sh.erb] Launching OpenRefine server on port ${port}..."
echo "[script.sh.erb] Logging to ${OPENREFINE_LOG_FILE}"

# Start OpenRefine in background and capture PID
nohup "${OPENREFINE_CMD}" \
  -p "${port}" \
  -d "${OPENREFINE_WORKDIR}" \
  -H "${REFINE_INTERFACE_IP}" \
  -i "${REFINE_INTERFACE_IP}" \
  -x refine.headless=true \
  > "${OPENREFINE_LOG_FILE}" 2>&1 &
OPENREFINE_PID=$!
echo "[script.sh.erb] OpenRefine started with PID: $OPENREFINE_PID"

# Wait for OpenRefine to start
echo "[script.sh.erb] Waiting for OpenRefine to initialize..."
sleep 10

# Check if OpenRefine is still running
if ! kill -0 $OPENREFINE_PID 2>/dev/null; then
  echo "[script.sh.erb] ERROR: OpenRefine process died. Check logs:"
  cat "${OPENREFINE_LOG_FILE}"
  exit 1
fi

echo "[script.sh.erb] OpenRefine Server Started successfully on port ${port}"

# Keep the script running to maintain the OpenRefine process
wait $OPENREFINE_PID
echo "[script.sh.erb] OpenRefine Server exited."
